<!DOCTYPE html>
<html lang="en">
<!--
  When to Meet ¬∑ A simple event timing vote
  Brought to you by DayBalancer LLC
  https://daybalancer.com
  Version 3.0
-->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DayBalancer ¬∑ When to Meet</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --primary:      #1B6896;
      --primary-dark: #154F74;
      --green:        #2E7D52;
      --green-light:  #E8F5EE;
      --light:        #F5F7FA;
      --border:       #DCE3EA;
      --dark:         #2C3A47;
      --muted:        #5A6B7A;
      --white:        #FFFFFF;
      --error:        #B91C1C;
      --gold:         #C07A00;
      --gold-light:   #FFF9EC;
    }
    body { font-family: "Nunito Sans", sans-serif; background: var(--light); color: var(--dark); min-height: 100vh; }

    /* Header */
    .header { background: var(--primary-dark); padding: 14px 20px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .logo { font-size: 20px; font-weight: 800; color: white; letter-spacing: -0.3px; }
    .logo span { font-weight: 400; }
    .header-tag { font-size: 10px; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.07em; }
    .code-badge { background: rgba(255,255,255,0.15); border: 1.5px solid rgba(255,255,255,0.3); border-radius: 8px; padding: 5px 12px; font-size: 12px; font-weight: 700; color: white; cursor: pointer; white-space: nowrap; }
    .code-badge:hover { background: rgba(255,255,255,0.25); }

    /* Layout */
    .page { max-width: 560px; margin: 0 auto; padding: 24px 16px 80px; }

    /* Cards */
    .card { background: var(--white); border-radius: 14px; border: 1.5px solid var(--border); padding: 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,.04); }

    /* Inputs */
    .field { margin-bottom: 18px; }
    .field-label { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.07em; color: var(--muted); margin-bottom: 6px; display: block; }
    .opt-label { font-weight: 400; text-transform: none; letter-spacing: 0; font-size: 11px; }
    .input { width: 100%; padding: 11px 14px; border: 1.5px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 15px; color: var(--dark); background: var(--white); outline: none; transition: border-color .15s; }
    .input:focus { border-color: var(--primary); }
    .input-lg { font-size: 18px; font-weight: 700; padding: 14px 16px; }

    /* Name hero */
    .name-hero { background: var(--primary-dark); border-radius: 14px; padding: 20px; margin-bottom: 14px; }
    .name-hero .field-label { color: rgba(255,255,255,0.7); margin-bottom: 8px; }
    .name-hero .input-lg { background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.25); color: white; }
    .name-hero .input-lg::placeholder { color: rgba(255,255,255,0.4); }
    .name-hero .input-lg:focus { border-color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.2); }
    .name-hero .err { color: rgba(255,160,160,1); }

    /* Buttons */
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 12px 22px; border-radius: 10px; font-family: inherit; font-size: 14px; font-weight: 700; cursor: pointer; border: none; transition: all .15s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-green  { background: var(--green); color: white; }
    .btn-green:hover { background: #256641; }
    .btn-outline { background: var(--white); color: var(--dark); border: 1.5px solid var(--border); }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
    .btn-ghost  { background: rgba(255,255,255,0.15); color: white; border: 1.5px solid rgba(255,255,255,0.35); }
    .btn-ghost:hover { background: rgba(255,255,255,0.25); }
    .btn-disabled { background: var(--border); color: var(--muted); cursor: not-allowed; }
    .btn-full   { width: 100%; }
    .btn-sm     { padding: 7px 14px; font-size: 13px; border-radius: 8px; }

    /* Toggles */
    .chip-row { display: flex; flex-wrap: wrap; gap: 6px; }
    .tog { padding: 6px 14px; border-radius: 20px; border: 1.5px solid var(--border); font-size: 13px; font-weight: 700; cursor: pointer; background: var(--white); color: var(--muted); transition: all .15s; font-family: inherit; }
    .tog.on { background: var(--primary-dark); border-color: var(--primary-dark); color: white; }
    .tog:hover:not(.on) { border-color: var(--primary); color: var(--primary); }

    /* Duration row */
    .dur-row { display: flex; gap: 8px; }
    .dur-row select { flex: 1; padding: 11px 10px; border: 1.5px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 14px; color: var(--dark); background: var(--white); outline: none; cursor: pointer; }
    .dur-row select:focus { border-color: var(--primary); }

    /* Specific option rows */
    .sopt-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
    .remove-btn { width: 34px; height: 34px; border-radius: 8px; border: 1.5px solid var(--border); background: var(--white); color: var(--muted); cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-family: inherit; transition: all .15s; }
    .remove-btn:hover { border-color: var(--error); color: var(--error); }

    /* Generated preview */
    .gen-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: var(--light); border-radius: 10px; margin-bottom: 6px; border: 1.5px solid var(--border); }
    .gen-row .g-label { font-size: 14px; font-weight: 700; }

    /* Vote cards */
    .vote-card { border-radius: 14px; border: 2.5px solid var(--border); padding: 14px 16px; margin-bottom: 10px; cursor: pointer; transition: all .15s; background: var(--white); display: flex; align-items: center; gap: 12px; }
    .vote-card:active { transform: scale(0.99); }
    .vote-card:hover  { border-color: var(--primary); box-shadow: 0 4px 14px rgba(27,104,150,.12); }
    .vote-card.picked { border-color: var(--green); background: var(--green-light); }
    .vote-card.is-winner { border-color: var(--gold); background: var(--gold-light); cursor: default; }
    .vote-check { width: 28px; height: 28px; border-radius: 50%; border: 2.5px solid var(--border); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 15px; transition: all .15s; }
    .vote-card.picked   .vote-check { background: var(--green); border-color: var(--green); color: white; }
    .vote-card.is-winner .vote-check { background: var(--gold); border-color: var(--gold); color: white; font-size: 13px; }
    .vote-body  { flex: 1; min-width: 0; }
    .vote-day   { font-size: 17px; font-weight: 800; }
    .vote-names { font-size: 11px; color: var(--muted); margin-top: 3px; }
    .bar-wrap   { height: 4px; background: var(--border); border-radius: 2px; margin-top: 7px; overflow: hidden; }
    .bar-fill   { height: 100%; border-radius: 2px; background: var(--primary); transition: width .4s; }
    .vote-card.picked .bar-fill { background: var(--green); }
    .vote-card.is-winner .bar-fill { background: var(--gold); }
    .vote-count { text-align: right; flex-shrink: 0; }
    .vote-num   { font-size: 22px; font-weight: 800; color: var(--primary); line-height: 1; }
    .vote-card.picked .vote-num { color: var(--green); }
    .vote-card.is-winner .vote-num { color: var(--gold); }
    .vote-lbl   { font-size: 11px; color: var(--muted); font-weight: 600; }

    /* Winner banner */
    .winner-banner { background: linear-gradient(135deg, #C07A00, #E8A000); border-radius: 14px; padding: 22px; text-align: center; margin-bottom: 14px; }
    .w-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: rgba(255,255,255,0.8); margin-bottom: 6px; }
    .w-date  { font-size: 24px; font-weight: 800; color: white; }
    .w-sub   { font-size: 14px; color: rgba(255,255,255,0.85); margin-top: 4px; }

    /* Suggest */
    .suggest-wrap { border-radius: 14px; border: 2px dashed var(--border); padding: 14px 16px; margin-bottom: 10px; cursor: pointer; text-align: center; color: var(--muted); font-weight: 700; font-size: 14px; background: var(--white); transition: all .15s; }
    .suggest-wrap:hover { border-color: var(--primary); color: var(--primary); }
    .suggest-form { padding: 14px; background: var(--light); border-radius: 10px; margin-top: 8px; display: none; }
    .suggest-form.open { display: block; }

    /* Who voted */
    .voter-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
    .voter-row:last-child { border-bottom: none; }
    .voter-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }

    /* Misc */
    .divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }
    .sec-title { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.07em; color: var(--muted); margin-bottom: 10px; }
    .err { font-size: 13px; font-weight: 600; color: var(--error); margin-top: 6px; display: none; }
    .bottom-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 14px; }

    /* Views */
    .view { display: none; }
    .view.active { display: block; }

    @media (max-width: 420px) {
      .vote-day { font-size: 15px; }
      .vote-num { font-size: 19px; }
      .card { padding: 16px 14px; }
    }
  </style>
</head>
<body>

<div class="header">
  <div>
    <div class="logo">Day<span>Balancer</span></div>
    <div class="header-tag">When to Meet</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center;">
    <div class="code-badge" id="header-code" style="display:none;" onclick="copyCode()">üìã Copy code</div>
    <button class="btn btn-ghost btn-sm" onclick="resetToHome()">+ New</button>
  </div>
</div>

<div class="page">

  <!-- HOME -->
  <div class="view active" id="view-home">
    <div class="card" style="text-align:center;padding:36px 24px;">
      <div style="font-size:40px;margin-bottom:12px;">üóìÔ∏è</div>
      <div style="font-size:24px;font-weight:800;margin-bottom:8px;">When to Meet</div>
      <p style="color:var(--muted);font-size:14px;line-height:1.6;margin-bottom:28px;">Propose a few times, share with others, select a winning time to meet.</p>
      <button class="btn btn-primary btn-full" style="margin-bottom:10px;padding:14px;" onclick="showView('setup')">üóìÔ∏è Find a time</button>
      <button class="btn btn-outline btn-full" style="padding:14px;" onclick="showView('join')">‚äû I have a code</button>
    </div>
  </div>

  <!-- JOIN -->
  <div class="view" id="view-join">
    <div class="card">
      <div style="font-size:20px;font-weight:800;margin-bottom:6px;">Join a vote</div>
      <p style="color:var(--muted);font-size:14px;margin-bottom:20px;">Someone should have shared a code with you - something like <strong style="color:var(--dark);">oak-river-42</strong></p>
      <div class="field">
        <label class="field-label">Code</label>
        <input class="input input-lg" id="join-code" placeholder="Enter code..." autocapitalize="none" spellcheck="false">
        <div class="err" id="join-err">Code not found. Double-check and try again.</div>
      </div>
      <button class="btn btn-primary btn-full" onclick="joinSession()" style="margin-bottom:10px;">Join ‚Üí</button>
      <button class="btn btn-outline btn-sm" onclick="showView('home')">‚Üê Back</button>
    </div>
  </div>

  <!-- SETUP -->
  <div class="view" id="view-setup">
    <div class="card">
      <div style="font-size:18px;font-weight:800;margin-bottom:20px;">Create a vote</div>

      <div class="field">
        <label class="field-label">Title</label>
        <input class="input input-lg" id="s-title" placeholder="Team sync, bonfire, lunch...">
        <div class="err" id="err-title">Please add a title.</div>
      </div>

      <hr class="divider">

      <!-- Method choice - no label needed, buttons are self-explanatory -->
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;">
        <button class="btn btn-outline" id="method-specific-btn" onclick="setMethod('specific')" style="flex:1;min-width:140px;padding:14px 10px;flex-direction:column;gap:4px;height:auto;">
          <div style="font-size:20px;">üìå</div>
          <div style="font-size:13px;font-weight:800;">I have specific<br>dates in mind</div>
        </button>
        <button class="btn btn-outline" id="method-generate-btn" onclick="setMethod('generate')" style="flex:1;min-width:140px;padding:14px 10px;flex-direction:column;gap:4px;height:auto;">
          <div style="font-size:20px;">‚ö°</div>
          <div style="font-size:13px;font-weight:800;">Generate options<br>for me</div>
        </button>
      </div>

      <!-- Duration moved into each panel -->


      <!-- Specific options panel -->
      <div id="panel-specific" style="display:none;">
        <div id="specific-list"></div>
        <button class="btn btn-outline btn-sm" id="add-sopt-btn" onclick="addSpecific()" style="margin-bottom:12px;">+ Add a date &amp; time</button>
        <div class="err" id="err-options">Add at least one option before creating the vote.</div>
        <div class="field" style="margin-top:4px;">
          <label class="field-label">Duration <span class="opt-label">(optional)</span></label>
          <div class="dur-row">
            <select id="dur-num">
              <option value="">-</option>
              <option value="30">30</option><option value="45">45</option>
              <option value="1" selected>1</option><option value="1.5">1.5</option>
              <option value="2">2</option><option value="3">3</option>
              <option value="4">4</option><option value="6">6</option>
              <option value="8">8</option><option value="12">12</option>
              <option value="24">24</option>
            </select>
            <select id="dur-unit">
              <option value="min">minutes</option>
              <option value="hr" selected>hours</option>
              <option value="day">days</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Generator panel -->
      <div id="panel-generate" style="display:none;">
        <div class="field">
          <label class="field-label">Preferred days <span class="opt-label">(none = any day)</span></label>
          <div class="chip-row" id="day-row">
            <button class="tog" data-v="1" onclick="multi(this)">Mon</button>
            <button class="tog" data-v="2" onclick="multi(this)">Tue</button>
            <button class="tog" data-v="3" onclick="multi(this)">Wed</button>
            <button class="tog" data-v="4" onclick="multi(this)">Thu</button>
            <button class="tog" data-v="5" onclick="multi(this)">Fri</button>
            <button class="tog on" data-v="6" onclick="multi(this)">Sat</button>
            <button class="tog on" data-v="0" onclick="multi(this)">Sun</button>
          </div>
        </div>

        <div class="field">
          <label class="field-label">Preferred time(s) of day <span class="opt-label">(none = any)</span></label>
          <div class="chip-row" id="tod-row">
            <button class="tog" data-v="morning"   onclick="multi(this)">Morning 7:00 am ‚Üí</button>
            <button class="tog" data-v="afternoon" onclick="multi(this)">Afternoon 12:00 pm ‚Üí</button>
            <button class="tog on" data-v="evening" onclick="multi(this)">Evening 5:00 pm ‚Üí</button>
            <button class="tog" data-v="late"      onclick="multi(this)">Late night 9:00 pm ‚Üí</button>
          </div>
        </div>

        <div class="field">
          <label class="field-label">Preferred time frame</label>
          <div class="chip-row" id="range-row">
            <button class="tog" data-v="week"    onclick="solo(this,'range-row')">This week</button>
            <button class="tog on" data-v="2w"   onclick="solo(this,'range-row')">Next 2 weeks</button>
            <button class="tog" data-v="month"   onclick="solo(this,'range-row')">This month</button>
            <button class="tog" data-v="quarter" onclick="solo(this,'range-row')">Next 3 months</button>
          </div>
        </div>

        <button class="btn btn-outline btn-full" onclick="generateOpts()">‚ö° Generate options</button>

        <div id="gen-preview" style="display:none;margin-top:14px;">
          <div class="sec-title" style="margin-bottom:8px;">Generated options <span class="opt-label">(remove any you don't want)</span></div>
          <div id="gen-list"></div>
        </div>
        <div class="err" id="err-options-gen">Generate at least one option before creating the vote.</div>

        <div class="field" style="margin-top:16px;">
          <label class="field-label">Duration <span class="opt-label">(optional)</span></label>
          <div class="dur-row">
            <select id="dur-num-gen">
              <option value="">-</option>
              <option value="30">30</option><option value="45">45</option>
              <option value="1" selected>1</option><option value="1.5">1.5</option>
              <option value="2">2</option><option value="3">3</option>
              <option value="4">4</option><option value="6">6</option>
              <option value="8">8</option><option value="12">12</option>
              <option value="24">24</option>
            </select>
            <select id="dur-unit-gen">
              <option value="min">minutes</option>
              <option value="hr" selected>hours</option>
              <option value="day">days</option>
            </select>
          </div>
        </div>
      </div>

      <hr class="divider" id="launch-divider" style="display:none;">
      <button class="btn btn-primary btn-full" id="launch-btn" onclick="launch()" style="padding:14px;display:none;">Create vote &amp; get share code ‚Üí</button>
      <div style="margin-top:10px;">
        <button class="btn btn-outline btn-sm" onclick="showView('home')">‚Üê Back</button>
      </div>
    </div>
  </div>

  <!-- VOTE -->
  <div class="view" id="view-vote">

    <div class="name-hero" id="name-hero">
      <label class="field-label">Your name</label>
      <input class="input input-lg" id="v-name" placeholder="What do people call you?" autocomplete="given-name" oninput="onNameInput()">
      <div class="err" id="err-vname">Please enter your name to vote.</div>
    </div>

    <div class="winner-banner" id="winner-banner" style="display:none;">
      <div class="w-label">üéâ It's happening!</div>
      <div class="w-date" id="winner-date"></div>
      <div class="w-sub"  id="winner-sub"></div>
    </div>

    <div class="card" style="padding:16px 18px;margin-bottom:12px;">
      <div style="font-size:20px;font-weight:800;" id="v-title"></div>
      <div style="font-size:13px;color:var(--muted);margin-top:3px;" id="v-meta"></div>
    </div>

    <div class="sec-title" style="margin:0 2px 8px;">Pick all times that work for you</div>

    <div id="vote-list"></div>

    <div class="suggest-wrap" id="sug-toggle" onclick="toggleSuggest()">
      ‚ûï None of these - suggest a different time
    </div>
    <div class="suggest-form" id="sug-form">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
        <div style="flex:1;min-width:130px;">
          <label class="field-label">Date</label>
          <input class="input" type="date" id="sug-date">
        </div>
        <div style="flex:1;min-width:110px;">
          <label class="field-label">Time</label>
          <input class="input" type="time" id="sug-time">
        </div>
      </div>
      <button class="btn btn-outline btn-sm btn-full" onclick="submitSuggestion()">Submit suggestion</button>
    </div>

    <div class="bottom-bar">
      <button class="btn btn-green btn-full" id="vote-btn" disabled onclick="submitVote()" style="padding:14px;">
        Save my votes
      </button>
    </div>

    <!-- Organizer section -->
    <div id="org-section" style="display:none;margin-top:24px;">
      <hr class="divider">
      <div class="sec-title">Organizer - confirm the date</div>
      <p style="font-size:13px;color:var(--muted);margin-bottom:12px;">Pick the winning time and everyone will see it confirmed.</p>
      <div id="org-list"></div>
    </div>

    <!-- Who voted -->
    <div id="who-section" style="display:none;margin-top:20px;">
      <hr class="divider">
      <div class="sec-title">Who voted</div>
      <div id="who-list"></div>
    </div>

  </div>

</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GS_URL = "https://script.google.com/macros/s/AKfycbzorQnmouatmpXCsPy1NBKnu-OdgpOdAkS5f4DikOIENU4TxzgqUhNbmRm2aXX2-g5c9w/exec";

const DAYS   = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const COLORS = ["#1B6896","#2E7D52","#C05A14","#1A6B7A","#5B4FCF","#B5116A","#C07A00","#1D7A5C"];
const TOD    = { morning:[7,8,9,10], afternoon:[12,13,14,15,16], evening:[17,18,19,20], late:[21,22,23] };

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let session  = null;
let code     = null;
let myName   = "";
let myPicks  = new Set();
let isOrg    = false;
let soptCount = 0;
let genOpts  = [];
let refreshTimer = null;

// ‚îÄ‚îÄ Tiny helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const esc  = s => String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
const uid  = () => Date.now().toString(36) + Math.random().toString(36).slice(2,5);
const addD = (d,n) => { const r=new Date(d); r.setDate(r.getDate()+n); return r; };
function makeCode() {
  const w1=["oak","pine","moss","heron","ember","stone","creek","fern","tide","reef"];
  const w2=["swift","calm","bright","deep","wild","free","warm","bold","clear","still"];
  return `${w1[Math.random()*10|0]}-${w2[Math.random()*10|0]}-${10+Math.random()*89|0}`;
}
function fmtHour(h) {
  const a=h>=12?"pm":"am", hr=h>12?h-12:(h===0?12:h);
  return `${hr}:00 ${a}`;
}
function fmtLabel(dateObj, hour) {
  return `${DAYS[dateObj.getDay()]}, ${MONTHS[dateObj.getMonth()]} ${dateObj.getDate()} ¬∑ ${fmtHour(hour)}`;
}
function durStr(s) {
  if (!s.durNum || s.durNum==="-" || s.durNum==="") return "";
  const n = s.durNum, u = s.durUnit;
  return `${n} ${u==="min"?"min":u==="hr"?(n==1?"hour":"hours"):(n==1?"day":"days")}`;
}

// ‚îÄ‚îÄ View switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showView(name) {
  document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
  document.getElementById("view-"+name).classList.add("active");
  window.scrollTo({top:0,behavior:"smooth"});
  if (name==="vote") startRefresh();
  else stopRefresh();
}
function resetToHome() {
  session=null; code=null; myName=""; myPicks.clear(); isOrg=false;
  soptCount=0; genOpts=[]; activeMethod=null;
  document.getElementById("header-code").style.display="none";
  document.getElementById("specific-list").innerHTML="";
  document.getElementById("gen-preview").style.display="none";
  document.getElementById("panel-specific").style.display="none";
  document.getElementById("panel-generate").style.display="none";
  showView("home");
}

// ‚îÄ‚îÄ Toggle helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function solo(el, rowId) { // single-select row
  document.querySelectorAll(`#${rowId} .tog`).forEach(t=>t.classList.remove("on"));
  el.classList.add("on");
}
function multi(el) { el.classList.toggle("on"); }
function getVals(rowId) {
  return [...document.querySelectorAll(`#${rowId} .tog.on`)].map(t=>t.dataset.v);
}

let activeMethod = null;
function setMethod(method) {
  activeMethod = method;
  // Highlight chosen button
  document.getElementById("method-specific-btn").style.borderColor = method==="specific" ? "var(--primary)" : "";
  document.getElementById("method-specific-btn").style.color       = method==="specific" ? "var(--primary)" : "";
  document.getElementById("method-generate-btn").style.borderColor = method==="generate" ? "var(--primary)" : "";
  document.getElementById("method-generate-btn").style.color       = method==="generate" ? "var(--primary)" : "";
  // Show duration
  // Show correct panel
  document.getElementById("panel-specific").style.display = method==="specific" ? "block" : "none";
  document.getElementById("panel-generate").style.display = method==="generate" ? "block" : "none";
  // Auto-open first row for specific
  if (method==="specific" && soptCount===0) addSpecific();
  // Launch button stays hidden until they add dates or generate options
  document.getElementById("launch-divider").style.display = "none";
  document.getElementById("launch-btn").style.display     = "none";
}

// ‚îÄ‚îÄ Specific options ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addSpecific() {
  if (soptCount >= 7) return;
  soptCount++;
  const id = "s"+soptCount;
  const wrap = document.getElementById("specific-list");
  const row = document.createElement("div");
  row.className = "sopt-row"; row.id = id;
  row.innerHTML = `
    <input type="date" class="input" id="${id}d" style="flex:1.2;">
    <input type="time" class="input" id="${id}t" style="flex:1;" value="18:00">
    <button class="remove-btn" onclick="removeSpecific('${id}')">√ó</button>`;
  wrap.appendChild(row);
  if (soptCount>=7) document.getElementById("add-sopt-btn").style.display="none";
  // Show launch button now that there's at least one date row
  document.getElementById("launch-divider").style.display = "block";
  document.getElementById("launch-btn").style.display     = "block";
}
function removeSpecific(id) {
  document.getElementById(id)?.remove();
  soptCount--;
  document.getElementById("add-sopt-btn").style.display="inline-flex";
}
function getSpecifics() {
  const out = [];
  document.querySelectorAll(".sopt-row").forEach(row => {
    const id=row.id, date=document.getElementById(id+"d")?.value, time=document.getElementById(id+"t")?.value;
    if (!date||!time) return;
    const d=new Date(date+"T"+time);
    const [hh,mm]=time.split(":").map(Number);
    const a=hh>=12?"pm":"am", hr=hh>12?hh-12:(hh===0?12:hh);
    const ms=mm>0?`:${String(mm).padStart(2,"0")}` :"";
    out.push({ id:uid(), label:`${DAYS[d.getDay()]}, ${MONTHS[d.getMonth()]} ${d.getDate()} ¬∑ ${hr}${ms} ${a}`, voters:[], ts:d.getTime() });
  });
  return out;
}

// ‚îÄ‚îÄ Generator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateOpts() {
  const range  = getVals("range-row")[0]||"2w";
  const days   = getVals("day-row").map(Number);
  const tods   = getVals("tod-row");
  const today  = new Date(); today.setHours(0,0,0,0);
  const end    = addD(today, range==="week"?7:range==="2w"?14:range==="month"?31:90);

  // Representative hours
  let hours=[];
  if (!tods.length) { hours=[9,12,17,21]; }
  else {
    tods.forEach(t => {
      const hs=TOD[t]||[];
      if (hs.length) hours.push(hs[0]);
    });
    hours=[...new Set(hours)].sort((a,b)=>a-b);
  }

  const candidates=[];
  let d=addD(today,1);
  while (d<=end) {
    const dow=d.getDay();
    if (!days.length||days.includes(dow)) {
      hours.forEach(h=>candidates.push({date:new Date(d),hour:h}));
    }
    d=addD(d,1);
  }
  if (!candidates.length) { alert("No options found - try different filters."); return; }

  const MAX=7;
  // Group candidates by date string to avoid skipping dates
  const byDate = {};
  candidates.forEach(c => {
    const key = c.date.toISOString().split("T")[0];
    if (!byDate[key]) byDate[key] = [];
    byDate[key].push(c);
  });
  const dates = Object.keys(byDate).sort();

  // Spread evenly across dates (not raw candidates)
  let pickedDates = dates.length <= MAX ? dates
    : Array.from({length:MAX}, (_,i) => dates[Math.round(i*(dates.length-1)/(MAX-1))]);

  // From each date, pick the earliest hour option
  let picked = pickedDates.map(dk => {
    const opts = byDate[dk];
    return opts[0];
  });

  genOpts = picked.map(c=>({
    id:uid(),
    label:fmtLabel(c.date,c.hour),
    voters:[],
    ts: new Date(c.date).setHours(c.hour,0,0,0)
  }));
  renderGenPreview();
  document.getElementById("launch-divider").style.display = "block";
  document.getElementById("launch-btn").style.display     = "block";
function renderGenPreview() {
  document.getElementById("gen-list").innerHTML = genOpts.map((o,i)=>`
    <div class="gen-row" id="gr${i}">
      <div class="g-label">${esc(o.label)}</div>
      <button class="btn btn-outline btn-sm" onclick="removeGen(${i})">Remove</button>
    </div>`).join("");
  document.getElementById("gen-preview").style.display = genOpts.length?"block":"none";
}
function removeGen(i) { genOpts.splice(i,1); renderGenPreview(); }

// ‚îÄ‚îÄ Launch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function launch() {
  const title = document.getElementById("s-title").value.trim();
  if (!title) { document.getElementById("err-title").style.display="block"; return; }
  document.getElementById("err-title").style.display="none";

  const specifics = activeMethod==="specific" ? getSpecifics() : [];
  const generated = activeMethod==="generate" ? genOpts : [];
  const all = [...specifics, ...generated].slice(0,7);

  if (!all.length) {
    const errId = activeMethod==="generate" ? "err-options-gen" : "err-options";
    document.getElementById(errId).style.display="block";
    return;
  }
  document.getElementById(activeMethod==="generate"?"err-options-gen":"err-options").style.display="none";

  const durNumId  = activeMethod==="generate" ? "dur-num-gen"  : "dur-num";
  const durUnitId = activeMethod==="generate" ? "dur-unit-gen" : "dur-unit";
  const durNum  = document.getElementById(durNumId)?.value  || "";
  const durUnit = document.getElementById(durUnitId)?.value || "hr";
  const orgPin  = uid().slice(0,6);
  const newCode = makeCode();

  const newSession = { title, durNum, durUnit, options:all, winner:null, organizerPin:orgPin, suggestions:[], voters:[], createdAt:Date.now() };

  try { await apiSave(newCode, newSession); } catch(e) { console.warn("Server save failed, local only", e); }

  session=newSession; code=newCode; isOrg=true;
  localStorage.setItem("org-"+newCode, orgPin);

  showHeader(newCode);
  showView("vote");
  renderVote();
}

// ‚îÄ‚îÄ Join ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function joinSession() {
  const c = document.getElementById("join-code").value.trim().toLowerCase();
  const errEl = document.getElementById("join-err");
  if (!c) return;
  try {
    const data = await apiGet(c);
    if (data?.session) {
      session=data.session; code=c;
      isOrg = localStorage.getItem("org-"+c)===session.organizerPin;
      errEl.style.display="none";
      showHeader(c);
      showView("vote");
      renderVote();
    } else { errEl.style.display="block"; }
  } catch(e) { errEl.style.display="block"; }
}

function showHeader(c) {
  const hc = document.getElementById("header-code");
  hc.style.display="flex"; hc.textContent=`üìã Code: ${c}`;
}
function copyCode() {
  if (!code) return;
  const txt=`Vote on when to meet for "${session?.title}" - use code: ${code} at https://jessieupp.github.io/DayBalancer-events/find-a-time.html`;
  navigator.clipboard.writeText(txt).then(()=>{
    document.getElementById("header-code").textContent="‚úì Copied!";
    setTimeout(()=>showHeader(code),2000);
  });
}

// ‚îÄ‚îÄ Render vote view ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderVote() {
  if (!session) return;
  document.getElementById("v-title").textContent = session.title;
  document.getElementById("v-meta").textContent  = `${durStr(session)} ¬∑ ${session.options.length} options to vote on`;

  // Winner
  const wb = document.getElementById("winner-banner");
  if (session.winner) {
    const w=session.options.find(o=>o.id===session.winner);
    if (w) {
      wb.style.display="block";
      document.getElementById("winner-date").textContent=w.label;
      document.getElementById("winner-sub").textContent=durStr(session);
      document.getElementById("name-hero").style.display="none";
    }
  } else {
    wb.style.display="none";
    document.getElementById("name-hero").style.display="block";
  }

  // Restore name + picks
  const saved = myName || localStorage.getItem("wtm-name-"+code)||"";
  if (saved) {
    document.getElementById("v-name").value=saved; myName=saved;
    myPicks=new Set(session.options.filter(o=>o.voters.some(v=>v.name.toLowerCase()===saved.toLowerCase())).map(o=>o.id));
  }

  renderCards();
  renderWho();
  updateBtn();

  // Org section
  const os=document.getElementById("org-section");
  if (isOrg&&!session.winner) { os.style.display="block"; renderOrgList(); }
  else os.style.display="none";
}

function renderCards() {
  const maxV=Math.max(...session.options.map(o=>o.voters.length),1);
  let html=session.options.map(o=>{
    const picked=myPicks.has(o.id), winner=session.winner===o.id;
    const cls=winner?"vote-card is-winner":picked?"vote-card picked":"vote-card";
    const check=winner?"üèÜ":picked?"‚úì":"";
    const pct=Math.round(o.voters.length/maxV*100);
    const names=o.voters.map(v=>esc(v.name)).join(", ");
    const disabled=session.winner?"style='cursor:default;pointer-events:none;'":"";
    return `<div class="${cls}" onclick="togglePick('${o.id}')" ${disabled}>
      <div class="vote-check">${check}</div>
      <div class="vote-body">
        <div class="vote-day">${esc(o.label)}</div>
        ${names?`<div class="vote-names">${names}</div>`:""}
        <div class="bar-wrap"><div class="bar-fill" style="width:${pct}%"></div></div>
      </div>
      <div class="vote-count">
        <div class="vote-num">${o.voters.length}</div>
        <div class="vote-lbl">${o.voters.length===1?"vote":"votes"}</div>
      </div>
    </div>`;
  }).join("");

  // Suggestions
  if (session.suggestions?.length) {
    html+=`<div class="sec-title" style="margin:16px 2px 8px;">Suggestions from voters</div>`;
    html+=session.suggestions.map(s=>`
      <div class="gen-row" style="border-style:dashed;">
        <div><div class="g-label">${esc(s.label)}</div><div style="font-size:12px;color:var(--muted);">Suggested by ${esc(s.name)}</div></div>
      </div>`).join("");
  }
  document.getElementById("vote-list").innerHTML=html;
}

function renderWho() {
  const voters=session.voters||[];
  const ws=document.getElementById("who-section");
  if (!voters.length) { ws.style.display="none"; return; }
  ws.style.display="block";
  document.getElementById("who-list").innerHTML=voters.map((v,i)=>`
    <div class="voter-row">
      <div class="voter-dot" style="background:${COLORS[i%COLORS.length]}"></div>
      <span style="font-size:14px;font-weight:600;">${esc(v.name)}</span>
      <span style="font-size:12px;color:var(--muted);margin-left:auto;">${v.count} ${v.count===1?"pick":"picks"}</span>
    </div>`).join("");
}

function renderOrgList() {
  document.getElementById("org-list").innerHTML=session.options.map(o=>`
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);">
      <div>
        <div style="font-weight:700;font-size:14px;">${esc(o.label)}</div>
        <div style="font-size:12px;color:var(--muted);">${o.voters.length} ${o.voters.length===1?"vote":"votes"}</div>
      </div>
      <button class="btn btn-green btn-sm" onclick="confirmWinner('${o.id}')">‚úì This one</button>
    </div>`).join("");
}

// ‚îÄ‚îÄ Interactions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePick(id) {
  if (session.winner) return;
  myPicks.has(id)?myPicks.delete(id):myPicks.add(id);
  renderCards(); updateBtn();
}
function onNameInput() { updateBtn(); }
function updateBtn() {
  const name=document.getElementById("v-name")?.value.trim();
  const btn=document.getElementById("vote-btn");
  const ok=name&&myPicks.size>0&&!session.winner;
  btn.disabled=!ok;
  btn.className="btn btn-full "+(ok?"btn-green":"btn-disabled");
}

async function submitVote() {
  const name=document.getElementById("v-name").value.trim();
  if (!name||!myPicks.size) return;
  myName=name; localStorage.setItem("wtm-name-"+code, name);

  // Remove previous votes from this person, add fresh
  session.options.forEach(o=>{
    o.voters=o.voters.filter(v=>v.name.toLowerCase()!==name.toLowerCase());
    if (myPicks.has(o.id)) o.voters.push({name});
  });
  if (!session.voters) session.voters=[];
  session.voters=session.voters.filter(v=>v.name.toLowerCase()!==name.toLowerCase());
  session.voters.push({name, count:myPicks.size});

  renderCards(); renderWho();
  const btn=document.getElementById("vote-btn");
  btn.textContent="Saved ‚úì"; btn.disabled=true;
  setTimeout(()=>{ btn.textContent="Save my votes"; updateBtn(); },2000);
  try { await apiSave(code,session); } catch(e) {}
}

function toggleSuggest() {
  document.getElementById("sug-form").classList.toggle("open");
}
async function submitSuggestion() {
  const name=document.getElementById("v-name")?.value.trim();
  const date=document.getElementById("sug-date").value;
  const time=document.getElementById("sug-time").value;
  if (!name) { alert("Enter your name first."); return; }
  if (!date||!time) { alert("Pick a date and time."); return; }
  const d=new Date(date+"T"+time);
  const [hh]=time.split(":").map(Number);
  const a=hh>=12?"pm":"am", hr=hh>12?hh-12:(hh===0?12:hh);
  const label=`${DAYS[d.getDay()]}, ${MONTHS[d.getMonth()]} ${d.getDate()} ¬∑ ${hr}:00 ${a}`;
  if (!session.suggestions) session.suggestions=[];
  session.suggestions.push({name,label});
  document.getElementById("sug-form").classList.remove("open");
  renderCards();
  try { await apiSave(code,session); } catch(e) {}
}

async function confirmWinner(optId) {
  session.winner=optId;
  const w=session.options.find(o=>o.id===optId);
  document.getElementById("winner-banner").style.display="block";
  document.getElementById("winner-date").textContent=w.label;
  document.getElementById("winner-sub").textContent=durStr(session);
  document.getElementById("name-hero").style.display="none";
  document.getElementById("org-section").style.display="none";
  document.getElementById("sug-toggle").style.display="none";
  const bb=document.querySelector(".bottom-bar");
  bb.innerHTML=`<button class="btn btn-primary btn-full" style="padding:14px;" onclick="shareWinner()">‚¨ÜÔ∏è Share the date with everyone</button>`;
  renderCards();
  try { await apiSave(code,session); } catch(e) {}
}

function shareWinner() {
  const w=session.options.find(o=>o.id===session.winner);
  const txt=`üìÖ It's official! "${session.title}" is happening ‚Üí ${w.label} (${durStr(session)}) üéâ`;
  if (navigator.share) navigator.share({title:session.title,text:txt});
  else navigator.clipboard.writeText(txt).then(()=>alert("Copied to clipboard!"));
}

// ‚îÄ‚îÄ Auto-refresh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startRefresh() {
  stopRefresh();
  refreshTimer=setInterval(async()=>{
    if (!code) return;
    try {
      const data=await apiGet(code);
      if (data?.session) {
        // Keep my current picks, update vote counts from server
        const srv=data.session;
        const myCurrentPicks=new Set(myPicks);
        session=srv;
        myPicks=myCurrentPicks;
        renderCards(); renderWho();
        if (srv.winner) renderVote(); // full re-render for winner state
      }
    } catch(e){}
  },8000);
}
function stopRefresh() { if(refreshTimer){clearInterval(refreshTimer);refreshTimer=null;} }

// ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function apiCall(params) {
  return new Promise((res,rej)=>{
    const cb="cb_"+Date.now()+"_"+Math.random().toString(36).slice(2);
    const to=setTimeout(()=>{delete window[cb];sc.remove();rej(new Error("timeout"));},12000);
    window[cb]=data=>{clearTimeout(to);delete window[cb];sc.remove();res(data);};
    const qs=Object.entries({...params,callback:cb}).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(typeof v==="object"?JSON.stringify(v):v)}`).join("&");
    const sc=document.createElement("script");
    sc.src=GS_URL+"?"+qs;
    sc.onerror=()=>{clearTimeout(to);delete window[cb];rej(new Error("failed"));};
    document.head.appendChild(sc);
  });
}
async function apiGet(c)       { return apiCall({action:"get",  code:c}); }
async function apiSave(c,sess) { return apiCall({action:"save", session:{...sess,code:c}}); }
</script>
</body>
</html>
